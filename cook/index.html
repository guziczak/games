<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moja Książka Kucharska</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #5a3921;
            --primary-light: #7a5941;
            --primary-dark: #402812;
            --secondary: #f8f1e9;
            --accent: #e67e22;
            --accent-light: #f39c12;
            --text: #333;
            --text-light: #666;
            --white: #fff;
            --gray: #f5f5f5;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --radius: 10px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--secondary);
            color: var(--text);
            line-height: 1.6;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--primary);
            color: var(--white);
            padding: 1.5rem;
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2rem;
            color: var(--white);
        }

        .logo i {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .logo h1 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-container input {
            width: 100%;
            padding: 0.7rem 1rem 0.7rem 2.5rem;
            border: none;
            border-radius: var(--radius);
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .search-container input:focus {
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .search-container i {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.6);
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.2rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .nav-item a {
            display: block;
            padding: 0.6rem 1rem;
            color: var(--white);
            text-decoration: none;
            font-size: 0.95rem;
            border-radius: var(--radius);
            transition: var(--transition);
        }

        .nav-item a:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active a {
            background: var(--accent);
            color: var(--white);
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            grid-column: 2;
            padding: 2rem;
            overflow-y: auto;
            min-height: 100vh;
            transition: var(--transition);
            padding-bottom: 4rem;
        }

        /* Welcome Screen */
        .welcome-screen {
            max-width: 800px;
            margin: 2rem auto;
            text-align: center;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-screen h2 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .welcome-screen p {
            color: var(--text-light);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .welcome-screen .welcome-image {
            max-width: 300px;
            margin: 0 auto 2rem auto;
            opacity: 0.9;
        }

        .category-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .category-card {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .category-card-image {
            height: 140px;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 2.5rem;
        }

        .category-card-content {
            padding: 1rem;
            text-align: center;
        }

        .category-card-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .category-card-count {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Recipe List */
        .recipe-list {
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-out;
        }

        .recipe-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .recipe-list-title {
            color: var(--primary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .recipe-list-title i {
            color: var(--accent);
        }

        .recipe-count {
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 0.3rem 0.8rem;
            background: var(--gray);
            border-radius: 20px;
        }

        .recipe-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .recipe-card {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .recipe-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .recipe-card-image {
            height: 160px;
            background-color: var(--primary-light);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 3rem;
        }

        .recipe-card-content {
            padding: 1rem;
        }

        .recipe-card-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .recipe-card-meta {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            gap: 1rem;
        }

        .recipe-card-meta div {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* Recipe Detail */
        .recipe-detail {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeIn 0.5s ease-out;
        }

        .recipe-detail-header {
            padding: 2rem;
            background: var(--primary);
            color: var(--white);
            position: relative;
        }

        .recipe-detail-title {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .recipe-detail-category {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .recipe-detail-meta {
            display: flex;
            gap: 1.5rem;
        }

        .recipe-detail-meta div {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .recipe-detail-content {
            padding: 2rem;
        }

        .recipe-section {
            margin-bottom: 2rem;
        }

        .recipe-section-title {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--secondary);
        }

        .ingredients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.8rem;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            background: var(--secondary);
            border-radius: var(--radius);
            font-size: 0.95rem;
        }

        .ingredient-amount {
            font-weight: 500;
            color: var(--primary);
        }

        .instruction-list {
            list-style: none;
            counter-reset: step-counter;
        }

        .instruction-item {
            position: relative;
            padding: 1rem 1rem 1rem 3rem;
            margin-bottom: 1rem;
            background: var(--secondary);
            border-radius: var(--radius);
        }

        .instruction-item:before {
            counter-increment: step-counter;
            content: counter(step-counter);
            position: absolute;
            left: 1rem;
            top: 1rem;
            background: var(--accent);
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Search Results */
        .search-results {
            max-width: 800px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-out;
        }

        .search-results-header {
            margin-bottom: 1.5rem;
        }

        .search-results-title {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-results-title i {
            color: var(--accent);
        }

        .search-results-count {
            color: var(--text-light);
        }

        .search-results-group {
            margin-bottom: 2rem;
        }

        .search-results-group-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--secondary);
        }

        .search-result-item {
            background: var(--white);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-result-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .search-result-category {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.8rem;
        }

        .match-highlight {
            color: var(--accent);
            background: rgba(230, 126, 34, 0.1);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-weight: 500;
        }

        .match-info {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.6rem;
        }

        /* Back button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: var(--gray);
            color: var(--text);
            border-radius: var(--radius);
            text-decoration: none;
            margin-bottom: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }

        .back-button:hover {
            background: var(--secondary);
        }

        /* Mobile Styles */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            z-index: 200;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                left: -280px;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                grid-column: 1;
            }

            .menu-toggle {
                display: flex;
            }

            .recipe-detail-meta {
                flex-direction: column;
                gap: 0.8rem;
            }

            .ingredients-grid {
                grid-template-columns: 1fr;
            }

            .category-cards, .recipe-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 1.5rem;
            }

            .recipe-detail-header {
                padding: 1.5rem;
            }

            .recipe-detail-title {
                font-size: 1.5rem;
            }

            .recipe-detail-content {
                padding: 1.5rem;
            }

            .category-cards, .recipe-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="overlay" id="overlay"></div>
<div class="menu-toggle" id="menuToggle">
    <i class="fas fa-bars"></i>
</div>

<div class="app-container">
    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <i class="fas fa-utensils"></i>
            <h1>Moja Książka Kucharska</h1>
        </div>

        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Szukaj przepisu...">
        </div>

        <nav class="nav-section">
            <h3 class="nav-title">
                <i class="fas fa-th-large"></i>
                <span>Kategorie</span>
            </h3>
            <ul class="nav-list" id="categoryList">
                <!-- Kategorie będą dodane przez JavaScript -->
            </ul>
        </nav>

        <div class="nav-section">
            <h3 class="nav-title">
                <i class="fas fa-book"></i>
                <span>Ostatnio przeglądane</span>
            </h3>
            <ul class="nav-list" id="recentRecipes">
                <!-- Ostatnie przepisy będą dodane przez JavaScript -->
            </ul>
        </div>
    </aside>

    <main class="main-content" id="mainContent">
        <!-- Tutaj będzie dynamicznie generowana zawartość -->
    </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
    // Model - obsługa danych
    class RecipeModel {
        constructor() {
            this.recipes = [];
            this.currentCategory = null;
            this.recentRecipes = [];
            this.searchResults = null;
        }

        async loadRecipesFromCSV() {
            try {
                const response = await fetch('recipes.csv');
                const csvData = await response.text();

                return new Promise((resolve, reject) => {
                    Papa.parse(csvData, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            // Przetwarzanie danych z CSV
                            this.recipes = results.data.map(row => {
                                // Przetwarzanie składników
                                const ingredients = row.ingredientsList.split(';').map(item => {
                                    const trimmedItem = item.trim();
                                    const parts = trimmedItem.split(' ');

                                    // Pobieramy ostatnie słowo jako nazwę, resztę jako ilość
                                    let name, amount;

                                    // Bardziej zaawansowane wykrywanie nazwy i ilości
                                    const amountRegex = /^([0-9.,/]+(\s*[a-zA-Z]+)?)/;
                                    const match = trimmedItem.match(amountRegex);

                                    if (match) {
                                        amount = match[0].trim();
                                        name = trimmedItem.substring(match[0].length).trim();
                                    } else {
                                        // Proste rozdzielenie
                                        amount = parts.slice(0, -1).join(' ');
                                        name = parts[parts.length - 1];
                                    }

                                    // Dodatkowa weryfikacja dla specjalnych przypadków
                                    if (name === "do" || name === "z") {
                                        const newParts = amount.split(' ');
                                        name = newParts[newParts.length - 1] + " " + name;
                                        amount = newParts.slice(0, -1).join(' ');
                                    }

                                    return { amount, name };
                                });

                                // Przetwarzanie instrukcji
                                const instructions = row.instructionsList.split(';')
                                    .map(item => item.trim())
                                    .filter(item => item.length > 0);

                                return {
                                    id: parseInt(row.id),
                                    title: row.title,
                                    category: row.category,
                                    prepTime: parseInt(row.prepTime),
                                    servings: parseInt(row.servings),
                                    ingredients,
                                    instructions
                                };
                            });

                            resolve(this.recipes);
                        },
                        error: (error) => {
                            reject(error);
                        }
                    });
                });
            } catch (error) {
                console.error('Błąd podczas ładowania przepisów:', error);
                throw error;
            }
        }

        getAllCategories() {
            const categories = [...new Set(this.recipes.map(recipe => recipe.category))];
            return categories.map(category => ({
                name: category,
                count: this.recipes.filter(recipe => recipe.category === category).length
            }));
        }

        getRecipesByCategory(category) {
            this.currentCategory = category;
            return this.recipes.filter(recipe => recipe.category === category);
        }

        getRecipeById(id) {
            return this.recipes.find(recipe => recipe.id === id);
        }

        addToRecentRecipes(recipe) {
            // Usuwamy jeśli już istnieje
            this.recentRecipes = this.recentRecipes.filter(r => r.id !== recipe.id);

            // Dodajemy na początek
            this.recentRecipes.unshift(recipe);

            // Ograniczamy do 5 ostatnich
            if (this.recentRecipes.length > 5) {
                this.recentRecipes.pop();
            }
        }

        searchRecipes(query) {
            if (!query || query.length < 2) {
                this.searchResults = null;
                return null;
            }

            const queryLower = query.toLowerCase().trim();
            const searchWords = queryLower.split(/\s+/).filter(word => word.length > 0);

            const exactMatches = [];
            const partialMatches = [];

            this.recipes.forEach(recipe => {
                const titleLower = recipe.title.toLowerCase();
                const categoryLower = recipe.category.toLowerCase();

                const matchInfo = {
                    matchedTitle: false,
                    matchedCategory: false,
                    matchedWords: [],
                    matchedIngredients: [],
                    matchedInstructions: []
                };

                // Sprawdzanie dokładnego dopasowania
                if (titleLower.includes(queryLower) || categoryLower.includes(queryLower)) {
                    matchInfo.matchedTitle = titleLower.includes(queryLower);
                    matchInfo.matchedCategory = categoryLower.includes(queryLower);
                    matchInfo.matchedWords = [...searchWords];

                    exactMatches.push({
                        recipe,
                        relevance: 1.0,
                        matchInfo
                    });
                    return;
                }

                // Sprawdzanie dopasowania poszczególnych słów
                const matchedWords = [];

                // Sprawdzanie w tytule i kategorii
                for (const word of searchWords) {
                    if (titleLower.includes(word)) {
                        matchedWords.push(word);
                        matchInfo.matchedTitle = true;
                    } else if (categoryLower.includes(word)) {
                        matchedWords.push(word);
                        matchInfo.matchedCategory = true;
                    }
                }

                // Sprawdzanie w składnikach
                for (const word of searchWords) {
                    for (const ingredient of recipe.ingredients) {
                        const ingredientName = ingredient.name.toLowerCase();
                        if (ingredientName.includes(word)) {
                            matchedWords.push(word);
                            matchInfo.matchedIngredients.push({
                                ingredient: ingredient.name,
                                searchWord: word
                            });
                            break;
                        }
                    }
                }

                // Sprawdzanie w instrukcjach
                for (const word of searchWords) {
                    for (let i = 0; i < recipe.instructions.length; i++) {
                        const instruction = recipe.instructions[i].toLowerCase();
                        if (instruction.includes(word)) {
                            matchedWords.push(word);
                            matchInfo.matchedInstructions.push({
                                instructionIndex: i,
                                instruction: recipe.instructions[i],
                                searchWord: word
                            });
                            break;
                        }
                    }
                }

                // Usuwanie duplikatów z matchedWords
                matchInfo.matchedWords = [...new Set(matchedWords)];

                // Klasyfikacja wyników
                if (matchInfo.matchedWords.length === searchWords.length) {
                    let relevanceScore = 0.7;
                    if (matchInfo.matchedTitle) relevanceScore += 0.2;
                    if (matchInfo.matchedCategory) relevanceScore += 0.1;

                    exactMatches.push({
                        recipe,
                        relevance: Math.min(1.0, relevanceScore),
                        matchInfo
                    });
                } else if (matchInfo.matchedWords.length > 0) {
                    const relevanceScore = 0.3 + (matchInfo.matchedWords.length / searchWords.length * 0.5);

                    partialMatches.push({
                        recipe,
                        relevance: relevanceScore,
                        matchInfo
                    });
                }
            });

            // Sortowanie wyników
            exactMatches.sort((a, b) => b.relevance - a.relevance);
            partialMatches.sort((a, b) => b.relevance - a.relevance);

            this.searchResults = {
                query,
                exact: exactMatches,
                partial: partialMatches
            };

            return this.searchResults;
        }
    }

    // View - obsługa interfejsu użytkownika
    class RecipeView {
        constructor() {
            // Główne elementy DOM
            this.mainContent = document.getElementById('mainContent');
            this.categoryList = document.getElementById('categoryList');
            this.recentRecipesList = document.getElementById('recentRecipes');
            this.searchInput = document.getElementById('searchInput');
            this.sidebar = document.getElementById('sidebar');
            this.menuToggle = document.getElementById('menuToggle');
            this.overlay = document.getElementById('overlay');

            // Inicjalizacja mobilnego menu
            this.initMobileMenu();
        }

        // Obsługa menú mobilnego
        initMobileMenu() {
            this.menuToggle.addEventListener('click', () => {
                this.sidebar.classList.toggle('active');
                this.overlay.style.display = this.sidebar.classList.contains('active') ? 'block' : 'none';
            });

            this.overlay.addEventListener('click', () => {
                this.sidebar.classList.remove('active');
                this.overlay.style.display = 'none';
            });
        }

        // Rendery widoków
        renderWelcomeScreen() {
            this.mainContent.innerHTML = `
                    <div class="welcome-screen">
                        <h2>Witaj w Mojej Książce Kucharskiej</h2>
                        <p>Odkryj kolekcję starannie dobranych przepisów kulinarnych. Wybierz kategorię z menu lub wyszukaj konkretny przepis.</p>
                        <div class="welcome-image">
                            <i class="fas fa-utensils" style="font-size: 5rem; color: var(--accent);"></i>
                        </div>
                        <p>Rozpocznij przygodę kulinarną już teraz!</p>
                    </div>
                `;
        }

        renderCategoryList(categories, onCategoryClick) {
            this.categoryList.innerHTML = '';

            categories.forEach(category => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.innerHTML = `
                        <a href="#" data-category="${category.name}">
                            ${category.name} <span class="recipe-count">${category.count}</span>
                        </a>
                    `;

                li.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();

                    // Ustawienie aktywnej kategorii
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');

                    onCategoryClick(category.name);

                    // Zamykanie menu na mobilnych
                    if (window.innerWidth <= 900) {
                        this.sidebar.classList.remove('active');
                        this.overlay.style.display = 'none';
                    }
                });

                this.categoryList.appendChild(li);
            });
        }

        renderRecentRecipes(recipes, onRecipeClick) {
            this.recentRecipesList.innerHTML = '';

            if (recipes.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Brak ostatnio przeglądanych przepisów';
                li.style.color = 'rgba(255, 255, 255, 0.6)';
                li.style.padding = '0.5rem 1rem';
                li.style.fontSize = '0.9rem';
                this.recentRecipesList.appendChild(li);
                return;
            }

            recipes.forEach(recipe => {
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.innerHTML = `<a href="#" data-id="${recipe.id}">${recipe.title}</a>`;

                li.querySelector('a').addEventListener('click', (e) => {
                    e.preventDefault();
                    onRecipeClick(recipe.id);

                    // Zamykanie menu na mobilnych
                    if (window.innerWidth <= 900) {
                        this.sidebar.classList.remove('active');
                        this.overlay.style.display = 'none';
                    }
                });

                this.recentRecipesList.appendChild(li);
            });
        }

        renderCategoryPage(category, recipes, onRecipeClick) {
            // Ikony dla różnych kategorii
            const categoryIcons = {
                'Zupy': 'fa-bowl-food',
                'Dania główne': 'fa-utensils',
                'Desery': 'fa-cookie',
                'Sałatki': 'fa-leaf',
                'Napoje': 'fa-glass-water',
                'Ciasta': 'fa-cake-candles'
            };

            // Domyślna ikona
            const defaultIcon = 'fa-utensils';

            const content = `
                    <button class="back-button" id="backButton">
                        <i class="fas fa-arrow-left"></i> Powrót
                    </button>

                    <div class="recipe-list">
                        <div class="recipe-list-header">
                            <h2 class="recipe-list-title">
                                <i class="fas ${categoryIcons[category] || defaultIcon}"></i>
                                ${category}
                            </h2>
                            <div class="recipe-count">
                                ${recipes.length} ${this.getProperForm(recipes.length, 'przepis', 'przepisy', 'przepisów')}
                            </div>
                        </div>

                        <div class="recipe-cards">
                            ${recipes.map(recipe => `
                                <div class="recipe-card" data-id="${recipe.id}">
                                    <div class="recipe-card-image">
                                        <i class="fas ${this.getRecipeIcon(recipe.title, recipe.category)}"></i>
                                    </div>
                                    <div class="recipe-card-content">
                                        <h3 class="recipe-card-title">${recipe.title}</h3>
                                        <div class="recipe-card-meta">
                                            <div>
                                                <i class="fas fa-clock"></i> ${recipe.prepTime} min
                                            </div>
                                            <div>
                                                <i class="fas fa-user"></i> ${recipe.servings} ${this.getProperForm(recipe.servings, 'porcja', 'porcje', 'porcji')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

            this.mainContent.innerHTML = content;

            // Obsługa przycisku powrotu
            document.getElementById('backButton').addEventListener('click', () => {
                this.renderWelcomeScreen();
            });

            // Obsługa kliknięcia na przepis
            document.querySelectorAll('.recipe-card').forEach(card => {
                card.addEventListener('click', () => {
                    const recipeId = parseInt(card.dataset.id);
                    onRecipeClick(recipeId);
                });
            });
        }

        renderRecipeDetail(recipe, onBackClick) {
            const content = `
                    <button class="back-button" id="backButton">
                        <i class="fas fa-arrow-left"></i> Powrót
                    </button>

                    <div class="recipe-detail">
                        <div class="recipe-detail-header">
                            <h2 class="recipe-detail-title">${recipe.title}</h2>
                            <div class="recipe-detail-category">${recipe.category}</div>

                            <div class="recipe-detail-meta">
                                <div>
                                    <i class="fas fa-clock"></i> Czas przygotowania: ${recipe.prepTime} minut
                                </div>
                                <div>
                                    <i class="fas fa-user"></i> Porcje: ${recipe.servings}
                                </div>
                            </div>
                        </div>

                        <div class="recipe-detail-content">
                            <div class="recipe-section">
                                <h3 class="recipe-section-title">
                                    <i class="fas fa-cart-shopping"></i> Składniki
                                </h3>
                                <div class="ingredients-grid">
                                    ${recipe.ingredients.map(ingredient => `
                                        <div class="ingredient-item">
                                            <i class="fas fa-check"></i>
                                            <span><span class="ingredient-amount">${ingredient.amount}</span> ${ingredient.name}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="recipe-section">
                                <h3 class="recipe-section-title">
                                    <i class="fas fa-list-ol"></i> Sposób przygotowania
                                </h3>
                                <div class="instruction-list">
                                    ${recipe.instructions.map(instruction => `
                                        <div class="instruction-item">${instruction}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

            this.mainContent.innerHTML = content;

            // Obsługa przycisku powrotu
            document.getElementById('backButton').addEventListener('click', () => {
                onBackClick();
            });
        }

        renderSearchResults(results, onRecipeClick) {
            if (!results) {
                return;
            }

            const { query, exact, partial } = results;
            const totalResults = exact.length + partial.length;

            let content = `
                    <button class="back-button" id="backButton">
                        <i class="fas fa-arrow-left"></i> Powrót
                    </button>

                    <div class="search-results">
                        <div class="search-results-header">
                            <h2 class="search-results-title">
                                <i class="fas fa-search"></i> Wyniki wyszukiwania
                            </h2>
                            <p class="search-results-count">
                                ${totalResults > 0
                ? `Znaleziono ${totalResults} ${this.getProperForm(totalResults, 'przepis', 'przepisy', 'przepisów')} dla "${query}"`
                : `Nie znaleziono przepisów dla "${query}"`}
                            </p>
                        </div>
                `;

            if (totalResults === 0) {
                content += `
                        <p>Spróbuj innych słów kluczowych lub przeglądaj przepisy według kategorii.</p>
                    `;
            } else {
                // Dokładne dopasowania
                if (exact.length > 0) {
                    content += `
                            <div class="search-results-group">
                                <h3 class="search-results-group-title">Najlepsze dopasowania</h3>
                                ${exact.map(match => this.createSearchResultItem(match, query)).join('')}
                            </div>
                        `;
                }

                // Częściowe dopasowania
                if (partial.length > 0) {
                    content += `
                            <div class="search-results-group">
                                <h3 class="search-results-group-title">Podobne przepisy</h3>
                                ${partial.map(match => this.createSearchResultItem(match, query)).join('')}
                            </div>
                        `;
                }
            }

            content += `</div>`;

            this.mainContent.innerHTML = content;

            // Obsługa przycisku powrotu
            document.getElementById('backButton').addEventListener('click', () => {
                this.renderWelcomeScreen();
            });

            // Obsługa kliknięcia na przepis
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    const recipeId = parseInt(item.dataset.id);
                    onRecipeClick(recipeId);
                });
            });
        }

        createSearchResultItem(match, query) {
            const { recipe, matchInfo } = match;

            // Przygotowanie tekstu z dopasowaniami
            let matchText = '';

            if (matchInfo.matchedTitle) {
                const titleHtml = this.highlightText(recipe.title, query);
                matchText += `<div class="match-info">Tytuł: ${titleHtml}</div>`;
            }

            if (matchInfo.matchedCategory) {
                const categoryHtml = this.highlightText(recipe.category, query);
                matchText += `<div class="match-info">Kategoria: ${categoryHtml}</div>`;
            }

            if (matchInfo.matchedIngredients.length > 0) {
                const ingredientsHtml = matchInfo.matchedIngredients
                    .slice(0, 2)
                    .map(m => `<span class="match-highlight">${m.searchWord}</span> (${m.ingredient})`)
                    .join(', ');

                matchText += `<div class="match-info">Składniki: ${ingredientsHtml}${matchInfo.matchedIngredients.length > 2 ? ' i inne...' : ''}</div>`;
            }

            if (matchInfo.matchedInstructions.length > 0) {
                const instructionsHtml = matchInfo.matchedInstructions
                    .slice(0, 1)
                    .map(m => `<span class="match-highlight">${m.searchWord}</span> (krok ${m.instructionIndex + 1})`)
                    .join(', ');

                matchText += `<div class="match-info">Instrukcje: ${instructionsHtml}${matchInfo.matchedInstructions.length > 1 ? ' i inne...' : ''}</div>`;
            }

            return `
                    <div class="search-result-item" data-id="${recipe.id}">
                        <h3 class="search-result-title">${recipe.title}</h3>
                        <div class="search-result-category">
                            <i class="fas fa-tag"></i> ${recipe.category}
                        </div>
                        <div class="search-result-meta">
                            <span><i class="fas fa-clock"></i> ${recipe.prepTime} min</span> ·
                            <span><i class="fas fa-user"></i> ${recipe.servings} ${this.getProperForm(recipe.servings, 'porcja', 'porcje', 'porcji')}</span>
                        </div>
                        ${matchText}
                    </div>
                `;
        }

        // Funkcje pomocnicze
        highlightText(text, query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            let result = text;

            for (const word of words) {
                const regex = new RegExp(`(${word})`, 'gi');
                result = result.replace(regex, '<span class="match-highlight">$1</span>');
            }

            return result;
        }

        getProperForm(count, form1, form2, form5) {
            if (count === 1) {
                return form1;
            } else if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) {
                return form2;
            } else {
                return form5;
            }
        }

        getRecipeIcon(title, category) {
            // Wybór ikony na podstawie kategorii lub tytułu
            const lowerTitle = title.toLowerCase();
            const lowerCategory = category.toLowerCase();

            if (lowerCategory.includes('zupa') || lowerTitle.includes('zupa')) return 'fa-bowl-food';
            if (lowerCategory.includes('deser') || lowerTitle.includes('deser')) return 'fa-ice-cream';
            if (lowerCategory.includes('ciasto') || lowerTitle.includes('ciasto')) return 'fa-cake-candles';
            if (lowerTitle.includes('sałat')) return 'fa-leaf';
            if (lowerTitle.includes('napój') || lowerTitle.includes('sok')) return 'fa-glass-water';
            if (lowerTitle.includes('mięso') || lowerTitle.includes('burger')) return 'fa-drumstick-bite';
            if (lowerTitle.includes('pizza')) return 'fa-pizza-slice';

            // Domyślna ikona
            return 'fa-utensils';
        }

        // Konfiguracja wyszukiwania
        setupSearch(onSearch) {
            let timeoutId = null;

            this.searchInput.addEventListener('input', () => {
                const query = this.searchInput.value.trim();

                // Czyszczenie poprzedniego timeouta
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }

                // Ustawienie opóźnienia dla wyszukiwania
                timeoutId = setTimeout(() => {
                    onSearch(query);
                }, 300);
            });
        }
    }

    // Controller - zarządzanie aplikacją
    class RecipeController {
        constructor(model, view) {
            this.model = model;
            this.view = view;

            // Konfiguracja wyszukiwania
            this.view.setupSearch(this.handleSearch.bind(this));
        }

        async init() {
            try {
                // Ładowanie przepisów
                await this.model.loadRecipesFromCSV();

                // Renderowanie początkowych widoków
                this.view.renderWelcomeScreen();
                this.renderCategories();
                this.renderRecentRecipes();
            } catch (error) {
                console.error('Błąd podczas inicjalizacji aplikacji:', error);
                alert('Nie udało się załadować aplikacji. Sprawdź konsolę, aby uzyskać więcej informacji.');
            }
        }

        renderCategories() {
            const categories = this.model.getAllCategories();
            this.view.renderCategoryList(categories, this.handleCategoryClick.bind(this));
        }

        renderRecentRecipes() {
            this.view.renderRecentRecipes(this.model.recentRecipes, this.handleRecipeClick.bind(this));
        }

        handleCategoryClick(category) {
            const recipes = this.model.getRecipesByCategory(category);
            this.view.renderCategoryPage(category, recipes, this.handleRecipeClick.bind(this));
        }

        handleRecipeClick(id) {
            const recipe = this.model.getRecipeById(id);

            if (recipe) {
                // Dodajemy do ostatnio oglądanych
                this.model.addToRecentRecipes(recipe);
                this.renderRecentRecipes();

                // Wyświetlamy szczegóły przepisu
                this.view.renderRecipeDetail(recipe, () => {
                    // Obsługa przycisku powrotu
                    if (this.model.searchResults) {
                        this.view.renderSearchResults(this.model.searchResults, this.handleRecipeClick.bind(this));
                    } else if (this.model.currentCategory) {
                        this.handleCategoryClick(this.model.currentCategory);
                    } else {
                        this.view.renderWelcomeScreen();
                    }
                });
            }
        }

        handleSearch(query) {
            if (!query || query.length < 2) {
                return;
            }

            const results = this.model.searchRecipes(query);
            this.view.renderSearchResults(results, this.handleRecipeClick.bind(this));
        }
    }

    // Inicjalizacja aplikacji
    document.addEventListener('DOMContentLoaded', () => {
        const model = new RecipeModel();
        const view = new RecipeView();
        const controller = new RecipeController(model, view);

        controller.init();
    });
</script>
</body>
</html>