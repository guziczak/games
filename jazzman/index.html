<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Jazzman 3.0 - Niesamowity Generator Jazzu</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #222222, #111111);
            color: #f0f0f0;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .container {
            max-width: 800px;
            width: 90%;
            background-color: rgba(30, 30, 30, 0.8);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            margin-top: 0;
            font-size: 2.5rem;
            color: #f5c542;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .control-group {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        button {
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f5c542;
            color: #222;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        button:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
            transition: transform 0.5s;
            opacity: 0;
        }
        
        button:hover {
            background-color: #f7d567;
            transform: translateY(-2px);
        }
        
        button:hover:after {
            transform: rotate(30deg) translate(10%, 10%);
            opacity: 0.3;
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.active {
            background-color: #f57167;
            color: white;
        }
        
        .main-button {
            background-color: #f55142;
            width: 100%;
            padding: 1rem;
            font-size: 1.3rem;
            position: relative;
            overflow: hidden;
        }
        
        .main-button:hover {
            background-color: #f57167;
        }
        
        /* Animacja przycisku */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 81, 66, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(245, 81, 66, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(245, 81, 66, 0);
            }
        }
        
        /* Animacja improvise */
        @keyframes improvise {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        button.improvising {
            background: linear-gradient(270deg, #f55142, #f5c542, #42b0f5, #a142f5);
            background-size: 800% 800%;
            animation: improvise 8s ease infinite;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .visualizer-container {
            position: relative;
            width: 100%;
            height: 150px;
            margin-top: 2rem;
            overflow: hidden;
        }
        
        .visualizer {
            width: 100%;
            height: 100px;
            background-color: rgba(20, 20, 20, 0.5);
            position: relative;
            overflow: hidden;
            border-radius: 5px;
        }
        
        .key {
            position: absolute;
            bottom: 0;
            border-radius: 3px 3px 0 0;
            transition: height 0.1s, opacity 0.5s;
        }
        
        .status {
            margin-top: 1rem;
            font-style: italic;
            color: #aaa;
        }
        
        .chord-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: #f5c542;
            margin-top: 0.5rem;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mood-display {
            font-size: 1.2rem;
            color: #aaa;
            margin-top: 0.5rem;
            height: 30px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            position: relative;
        }
        
        .slider-container label {
            min-width: 120px;
            text-align: right;
        }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 5px;
            background: #444;
            border-radius: 5px;
            background-image: linear-gradient(#f5c542, #f5c542);
            background-repeat: no-repeat;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 15px;
            width: 15px;
            border-radius: 50%;
            background: #f5c542;
            cursor: pointer;
            box-shadow: 0 0 2px 0 #555;
            transition: background .3s ease-in-out;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #f7d567;
        }
        
        .value-display {
            min-width: 50px;
            text-align: left;
        }
        
        /* Komunikat o bdzie */
        .error-message {
            color: #f55142;
            font-weight: bold;
            padding: 0.5rem;
            margin-top: 1rem;
            border: 1px solid #f55142;
            border-radius: 5px;
            display: none;
        }

        /* Notes Animation */
        .notes-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .note {
            position: absolute;
            font-size: 20px;
            animation: float 4s ease-in forwards;
            opacity: 0;
        }
        
        @keyframes float {
            0% {
                transform: translateY(20px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) rotate(20deg);
                opacity: 0;
            }
        }
        
        /* Auto-Jazz Mode */
        .auto-jazz-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 1rem;
            position: relative;
            padding: 1rem;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .auto-jazz-active {
            background: rgba(245, 81, 66, 0.1);
            box-shadow: 0 0 10px rgba(245, 81, 66, 0.3);
        }
        
        .auto-jazz-button {
            background: linear-gradient(135deg, #f55142, #f5c542);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            padding: 0.8rem 1.2rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            width: 100%;
        }
        
        .auto-jazz-button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        
        .auto-jazz-meter {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .auto-jazz-progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f55142, #f5c542);
            transition: width 0.2s;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Swing text effect */
        .swing-text {
            display: inline-block;
            animation: swingText 2s ease-in-out infinite alternate;
            transform-origin: center;
        }
        
        @keyframes swingText {
            0% {
                transform: rotate(-5deg);
            }
            100% {
                transform: rotate(5deg);
            }
        }
        
        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .gradient-text {
            background: linear-gradient(90deg, #f55142, #f5c542, #42b0f5, #a142f5);
            background-size: 300% 300%;
            animation: gradientBG 6s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        /* Dodano animacje aktywnoci */
        @keyframes pulse-key {
            0% {
                transform: scaleY(1);
            }
            50% {
                transform: scaleY(1.1);
            }
            100% {
                transform: scaleY(1);
            }
        }
        
        .key.active {
            animation: pulse-key 0.3s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="swing-text">Super Jazzman</span> <span class="gradient-text">3.0</span></h1>
        
        <div class="visualizer-container">
            <div class="visualizer" id="visualizer"></div>
            <div class="chord-display" id="chordDisplay">-</div>
            <div class="mood-display" id="moodDisplay">czekam na inspiracj...</div>
        </div>
        
        <div class="controls">
            <button id="startButton" class="main-button">AKTYWUJ JAZZOWE AUDIO</button>
            
            <div class="slider-container">
                <label for="tempo">Tempo:</label>
                <input type="range" id="tempo" min="60" max="240" value="120">
                <span class="value-display" id="tempoValue">120 BPM</span>
            </div>
            
            <div class="auto-jazz-container" id="autoJazzContainer">
                <button id="autoJazzButton" class="auto-jazz-button tooltip">
                    TRYB AUTO-JAZZ
                    <span class="tooltiptext">Wcz, aby Jazzman sam sterowa zo偶onoci i eksperymentowa z brzmieniem</span>
                </button>
                <div class="auto-jazz-meter">
                    <div class="auto-jazz-progress" id="autoJazzProgress"></div>
                </div>
            </div>
            
            <div class="control-group">
                <button id="pianoToggle" class="active">Piano: ON</button>
                <button id="bassToggle" class="active">Bas: ON</button>
                <button id="drumsToggle" class="active">Perkusja: ON</button>
                <button id="trumpetToggle" class="active">Trbka: ON</button>
            </div>
            
            <div class="control-group">
                <button id="styleSwing" class="active">Swing</button>
                <button id="styleBebop">Bebop</button>
                <button id="styleFusion">Fusion</button>
                <button id="styleModal">Modal</button>
            </div>
        </div>
        
        <div class="status" id="status">Kliknij AKTYWUJ, aby rozpocz jazzow przygod...</div>
        <div class="error-message" id="errorMessage"></div>
        <div style="margin-top: 1rem; font-size: 0.9rem;">
            <p> <strong>Wskaz贸wka:</strong> Kliknij "TRYB AUTO-JAZZ", aby Jazzman sam improwizowa i sterowa przebiegiem muzyki!</p>
        </div>

        <div class="notes-animation" id="notesAnimation"></div>
    </div>

    <script>
        // CZ 1: DEFINICJE I STAE

        // Lista mo偶liwych nastroj贸w muzycznych
        const MOODS = [
            'spokojny', 'energiczny', 'nastrojowy', 'melancholijny', 
            'radosny', 'zaskakujcy', 'eksperymentalny', 'minimalistyczny', 
            'intensywny', 'kontemplacyjny'
        ];

        // Lista akord贸w jazzowych
        const JAZZ_CHORDS = {
            major7: ['Cmaj7', 'Dbmaj7', 'Dmaj7', 'Ebmaj7', 'Emaj7', 'Fmaj7', 'Gbmaj7', 'Gmaj7', 'Abmaj7', 'Amaj7', 'Bbmaj7', 'Bmaj7'],
            minor7: ['Cm7', 'Dbm7', 'Dm7', 'Ebm7', 'Em7', 'Fm7', 'Gbm7', 'Gm7', 'Abm7', 'Am7', 'Bbm7', 'Bm7'],
            dominant7: ['C7', 'Db7', 'D7', 'Eb7', 'E7', 'F7', 'Gb7', 'G7', 'Ab7', 'A7', 'Bb7', 'B7'],
            half_diminished: ['Cm7b5', 'Dbm7b5', 'Dm7b5', 'Ebm7b5', 'Em7b5', 'Fm7b5', 'Gbm7b5', 'Gm7b5', 'Abm7b5', 'Am7b5', 'Bbm7b5', 'Bm7b5'],
            altered: ['C7b9', 'Db7b9', 'D7b9', 'Eb7b9', 'E7b9', 'F7b9', 'Gb7b9', 'G7b9', 'Ab7b9', 'A7b9', 'Bb7b9', 'B7b9'],
            extended: ['C9', 'Db9', 'D9', 'Eb9', 'E9', 'F9', 'Gb9', 'G9', 'Ab9', 'A9', 'Bb9', 'B9', 'C13', 'G13', 'D13'],
            misc: ['Cmaj9', 'Fmaj9', 'Dm9', 'Gm9', 'Csus4', 'Fsus4', 'C6', 'F6', 'Am6', 'Dm6']
        };

        // Progresje akord贸w jazzowych wg stylu
        const JAZZ_PROGRESSIONS = {
            swing: [
                ['Dm7', 'G7', 'Cmaj7', 'Cmaj7'], // ii-V-I
                ['Cmaj7', 'Am7', 'Dm7', 'G7'],   // I-vi-ii-V
                ['Dm7', 'G7', 'Em7', 'A7', 'Dm7', 'G7', 'Cmaj7', 'Cmaj7'] // ii-V-iii-VI-ii-V-I
            ],
            bebop: [
                ['Cmaj7', 'Cm7', 'F7', 'Bbmaj7', 'Bbm7', 'Eb7', 'Abmaj7', 'G7'], // Coltrane changes
                ['Dm7', 'G7', 'Cmaj7', 'A7', 'Dm7', 'G7', 'Cmaj7', 'Cmaj7'],     // ii-V-I z alteracjami
                ['Cmaj7', 'E7', 'Am7', 'D7', 'Dmaj7', 'F7', 'Bbmaj7', 'G7']      // Pattern z modulacjami
            ],
            fusion: [
                ['Cmaj7', 'Dbmaj7', 'Dmaj7', 'Ebmaj7'],     // Modulacje chromatyczne
                ['Em7', 'A7', 'Dmaj7', 'Gmaj7', 'Cmaj7'],   // Sekwencje kwintowe
                ['Csus4', 'Fsus4', 'Gsus4', 'Ebmaj7', 'Dm7'] // Brzmienia modalne
            ],
            modal: [
                ['Dm7', 'Dm7', 'Dm7', 'Dm7', 'Dm7', 'Dm7', 'Dm7', 'Dm7'],        // Dorian
                ['Cmaj7', 'Cmaj7', 'Cmaj7', 'Cmaj7', 'Fmaj7', 'Fmaj7', 'Cmaj7', 'Cmaj7'], // Ionian
                ['Em7', 'Em7', 'Em7', 'Em7', 'Em7', 'Em7', 'Em7', 'Em7']          // Phrygian
            ]
        };

        // Czstotliwoci dla podstawowych nut (C4, C3, etc.)
        const NOTE_FREQUENCIES = {
            'C': 261.63,
            'Db': 277.18,
            'D': 293.66,
            'Eb': 311.13,
            'E': 329.63,
            'F': 349.23,
            'Gb': 369.99,
            'G': 392.00,
            'Ab': 415.30,
            'A': 440.00,
            'Bb': 466.16,
            'B': 493.88
        };

        // Interway muzyczne dla akord贸w (wsp贸czynniki dla harmonii)
        const INTERVALS = {
            unison: 1,
            minor2nd: 1.0595,
            major2nd: 1.1225,
            minor3rd: 1.1892,
            major3rd: 1.2599,
            perfect4th: 1.3348,
            tritone: 1.4142,
            perfect5th: 1.4983,
            minor6th: 1.5874,
            major6th: 1.6818,
            minor7th: 1.7818,
            major7th: 1.8877,
            octave: 2
        };

        // G贸wne kolory dla typ贸w akord贸w
        const CHORD_COLORS = {
            'maj7': { h: 60, s: 80, l: 60 },   // zoty
            'maj9': { h: 40, s: 80, l: 60 },   // pomaraczowy
            'm7': { h: 240, s: 70, l: 60 },    // niebieski
            'm9': { h: 260, s: 70, l: 60 },    // fioletowy
            '7': { h: 0, s: 70, l: 60 },       // czerwony
            '9': { h: 330, s: 70, l: 60 },     // r贸偶owy
            'dim7': { h: 300, s: 70, l: 60 },  // purpurowy
            'm7b5': { h: 280, s: 70, l: 60 },  // fioletowo-purpurowy
            'sus4': { h: 180, s: 70, l: 60 },  // turkusowy
            '13': { h: 30, s: 70, l: 60 },     // jasnopomaraczowy
            '7b9': { h: 345, s: 80, l: 50 },   // bordowy
            '6': { h: 70, s: 70, l: 60 },      // 偶贸to-zielony
            'm6': { h: 200, s: 70, l: 60 }     // niebieskozielony
        };

        // CZ 2: STAN APLIKACJI I GWNE KOMPONENTY

        // Stan aplikacji
        const state = {
            audioInitialized: false,
            audioContext: null,
            isPlaying: false,
            tempo: 120,
            complexity: 0.5,
            currentChord: null,
            currentProgression: [],
            progressionIndex: 0,
            currentMood: 'spokojny',
            style: 'swing',
            autoJazz: false,
            autoJazzTimer: null,
            chordTimer: null,
            piano: true,
            bass: true,
            drums: true,
            trumpet: true,
            instruments: {},
            effects: {}
        };

        // Obiekt wizualizatora
        const visualizer = {
            element: null,
            chordDisplay: null,
            moodDisplay: null,
            keys: [],
            
            init: function() {
                this.element = document.getElementById('visualizer');
                this.chordDisplay = document.getElementById('chordDisplay');
                this.moodDisplay = document.getElementById('moodDisplay');
                this.updateMoodDisplay(state.currentMood);
            },
            
            updateChordDisplay: function(chord) {
                if (!chord) return;
                
                this.chordDisplay.textContent = chord;
                this.chordDisplay.style.color = this.getChordColor(chord);
                
                // Dodaj efekt pulsu
                this.chordDisplay.classList.add('pulse');
                setTimeout(() => this.chordDisplay.classList.remove('pulse'), 300);
            },
            
            updateMoodDisplay: function(mood) {
                this.moodDisplay.textContent = mood;
            },
            
            getChordColor: function(chord) {
                // Znajd藕 odpowiedni kolor dla akordu
                let chordType = '';
                
                if (chord.includes('maj9')) {
                    chordType = 'maj9';
                } else if (chord.includes('maj7')) {
                    chordType = 'maj7';
                } else if (chord.includes('m7b5')) {
                    chordType = 'm7b5';
                } else if (chord.includes('m9')) {
                    chordType = 'm9';
                } else if (chord.includes('m7')) {
                    chordType = 'm7';
                } else if (chord.includes('7b9')) {
                    chordType = '7b9';
                } else if (chord.includes('13')) {
                    chordType = '13';
                } else if (chord.includes('9')) {
                    chordType = '9';
                } else if (chord.includes('7')) {
                    chordType = '7';
                } else if (chord.includes('dim')) {
                    chordType = 'dim7';
                } else if (chord.includes('sus')) {
                    chordType = 'sus4';
                } else if (chord.includes('m6')) {
                    chordType = 'm6';
                } else if (chord.includes('6')) {
                    chordType = '6';
                }
                
                const color = CHORD_COLORS[chordType];
                if (color) {
                    return `hsl(${color.h}, ${color.s}%, ${color.l}%)`;
                }
                return '#f5c542'; // Domylny zoty
            },
            
            clearNotes: function() {
                for (let key of this.keys) {
                    try {
                        if (this.element.contains(key)) {
                            this.element.removeChild(key);
                        }
                    } catch (e) {
                        console.error("Bd podczas usuwania klawisza:", e);
                    }
                }
                this.keys = [];
            },
            
            createNote: function(x, color, duration = 1500) {
                if (!this.element) return;
                
                const key = document.createElement('div');
                key.className = 'key';
                key.style.left = `${x % (this.element.clientWidth - 20)}px`;
                key.style.width = '20px';
                key.style.height = '0px';
                key.style.backgroundColor = color || `hsl(${Math.random() * 360}, 80%, 60%)`;
                
                this.element.appendChild(key);
                this.keys.push(key);
                
                // Animacja pojawienia si
                setTimeout(() => {
                    key.style.height = '80px';
                    key.style.opacity = '0.8';
                }, 0);
                
                // Animacja zniknicia
                setTimeout(() => {
                    key.style.opacity = '0';
                    setTimeout(() => {
                        if (this.element.contains(key)) {
                            this.element.removeChild(key);
                        }
                        const index = this.keys.indexOf(key);
                        if (index > -1) {
                            this.keys.splice(index, 1);
                        }
                    }, 500);
                }, duration);
                
                // Ogranicz liczb nut
                while (this.keys.length > 50) {
                    const oldKey = this.keys.shift();
                    if (this.element.contains(oldKey)) {
                        this.element.removeChild(oldKey);
                    }
                }
                
                return key;
            }
        };

        // Obiekt Auto-Jazz (sterownik automatycznej improwizacji)
        const autoJazz = {
            active: false,
            progress: 0,
            direction: 1,
            maxValue: 100,
            progressBar: null,
            container: null,
            button: null,
            
            init: function() {
                this.progressBar = document.getElementById('autoJazzProgress');
                this.container = document.getElementById('autoJazzContainer');
                this.button = document.getElementById('autoJazzButton');
                this.updateVisuals();
            },
            
            updateVisuals: function() {
                if (this.active) {
                    this.container.classList.add('auto-jazz-active');
                    this.button.textContent = 'AUTO-JAZZ AKTYWNY!';
                    this.button.classList.add('improvising');
                } else {
                    this.container.classList.remove('auto-jazz-active');
                    this.button.textContent = 'TRYB AUTO-JAZZ';
                    this.button.classList.remove('improvising');
                    this.progress = 0;
                }
                
                this.progressBar.style.width = `${this.progress}%`;
            },
            
            start: function() {
                this.active = true;
                this.progress = 0;
                this.direction = 1;
                this.updateVisuals();
                
                // Uruchom timer
                if (state.autoJazzTimer) {
                    clearInterval(state.autoJazzTimer);
                }
                
                state.autoJazzTimer = setInterval(() => this.update(), 400);
            },
            
            stop: function() {
                this.active = false;
                
                // Zatrzymaj timer
                if (state.autoJazzTimer) {
                    clearInterval(state.autoJazzTimer);
                    state.autoJazzTimer = null;
                }
                
                this.updateVisuals();
            },
            
            update: function() {
                // Aktualizuj progres
                this.progress += this.direction * (5 + Math.random() * 10);
                
                // Ogranicz progres do zakresu 0-100
                if (this.progress >= this.maxValue) {
                    this.progress = this.maxValue;
                    this.direction = -1;
                    this.takeAction(); // Wykonaj akcj po osigniciu maksimum
                } else if (this.progress <= 0) {
                    this.progress = 0;
                    this.direction = 1;
                }
                
                // Aktualizuj wizualizacj
                this.progressBar.style.width = `${this.progress}%`;
            },
            
            takeAction: function() {
                if (!state.isPlaying) {
                    // Jeli nie odtwarzamy, uruchom odtwarzanie
                    if (state.audioInitialized) {
                        togglePlayJazz();
                    }
                    return;
                }
                
                // Wybierz losow akcj
                const action = Math.random();
                
                if (action < 0.3) {
                    // Zmie nastr贸j
                    changeRandomMood();
                } else if (action < 0.5) {
                    // Zmie styl
                    changeRandomStyle();
                } else if (action < 0.8) {
                    // Zmie progresj akord贸w
                    generateNewProgression();
                } else {
                    // Zmie tempo
                    changeRandomTempo();
                }
                
                // Efekt wizualny
                createJazzEffect();
            }
        };

        // CZ 3: INICJALIZACJA APLIKACJI

        // Funkcja inicjalizujca aplikacj
        function initializeApp() {
            // Inicjalizuj wizualizator
            visualizer.init();
            
            // Inicjalizuj Auto-Jazz
            autoJazz.init();
            
            // Ustaw domylny nastr贸j
            state.currentMood = MOODS[Math.floor(Math.random() * MOODS.length)];
            visualizer.updateMoodDisplay(state.currentMood);
            
            // Przypisz obsug zdarze
            setupEventListeners();
            
            // Zaaktualizuj status
            updateStatus("Kliknij AKTYWUJ JAZZOWE AUDIO, aby rozpocz...");
            
            // Animuj przycisk
            document.getElementById('startButton').style.animation = 'pulse 1.5s infinite';
        }

        // Obsuga zdarze
        function setupEventListeners() {
            // G贸wny przycisk
            document.getElementById('startButton').addEventListener('click', handleMainButtonClick);
            
            // Przyciski instrument贸w
            document.getElementById('pianoToggle').addEventListener('click', () => toggleInstrument('piano'));
            document.getElementById('bassToggle').addEventListener('click', () => toggleInstrument('bass'));
            document.getElementById('drumsToggle').addEventListener('click', () => toggleInstrument('drums'));
            document.getElementById('trumpetToggle').addEventListener('click', () => toggleInstrument('trumpet'));
            
            // Przyciski stylu
            document.getElementById('styleSwing').addEventListener('click', () => setStyle('swing'));
            document.getElementById('styleBebop').addEventListener('click', () => setStyle('bebop'));
            document.getElementById('styleFusion').addEventListener('click', () => setStyle('fusion'));
            document.getElementById('styleModal').addEventListener('click', () => setStyle('modal'));
            
            // Suwak tempa
            document.getElementById('tempo').addEventListener('input', updateTempo);
            
            // Przycisk Auto-Jazz
            document.getElementById('autoJazzButton').addEventListener('click', toggleAutoJazz);
        }

        // Obsuga g贸wnego przycisku
        function handleMainButtonClick() {
            if (!state.audioInitialized) {
                // Inicjalizacja audio
                initializeAudio();
            } else {
                // Przeczenie odtwarzania
                togglePlayJazz();
            }
        }

        // CZ 4: INICJALIZACJA AUDIO I INSTRUMENTW

        // Inicjalizacja kontekstu audio
        function initializeAudio() {
            try {
                // Aktualizuj status
                updateStatus("Inicjalizacja audio...");
                
                // Tworzenie kontekstu audio
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Inicjalizacja instrument贸w
                initializeInstruments();
                
                // Ustawienie stanu
                state.audioInitialized = true;
                
                // Aktualizacja UI
                document.getElementById('startButton').textContent = "START JAZZU";
                updateStatus("Audio zainicjalizowane! Kliknij START, aby rozpocz jazzowanie!");
                
                console.log("Audio successfully initialized!");
                
                // Odtw贸rz kr贸tki d藕wik, aby przetestowa audio
                playTestSound();
                
            } catch (error) {
                console.error("Bd inicjalizacji audio:", error);
                displayError("Nie udao si zainicjalizowa audio: " + error.message);
            }
        }

        // Inicjalizacja instrument贸w
        function initializeInstruments() {
            // Master gain node - g贸wne sterowanie gonoci
            state.masterGain = state.audioContext.createGain();
            state.masterGain.gain.value = 0.7;
            state.masterGain.connect(state.audioContext.destination);
            
            // Reverb (pogos) - wsp贸lny efekt
            createReverbEffect();
            
            // Inicjalizacja instrument贸w
            initPiano();
            initBass();
            initDrums();
            initTrumpet();
        }

        // Stworzenie efektu reverb
        function createReverbEffect() {
            // Tworzymy konwolucyjny reverb
            state.effects.reverb = state.audioContext.createConvolver();
            
            // Tworzymy bufor impulsu reverbu
            const reverbTime = 2; // czas reverbu w sekundach
            const sampleRate = state.audioContext.sampleRate;
            const bufferLength = sampleRate * reverbTime;
            const buffer = state.audioContext.createBuffer(2, bufferLength, sampleRate);
            
            // Wypeniamy lewy kana
            const leftChannel = buffer.getChannelData(0);
            // Wypeniamy prawy kana
            const rightChannel = buffer.getChannelData(1);
            
            // Generujemy prosty impuls reverbu
            for (let i = 0; i < bufferLength; i++) {
                // Decreasing exponential
                const amplitude = Math.pow(1 - i / bufferLength, 1.5);
                leftChannel[i] = (Math.random() * 2 - 1) * amplitude;
                rightChannel[i] = (Math.random() * 2 - 1) * amplitude;
            }
            
            // Przypisujemy bufor
            state.effects.reverb.buffer = buffer;
            
            // Tworzymy dry/wet mix
            state.effects.reverbDry = state.audioContext.createGain();
            state.effects.reverbWet = state.audioContext.createGain();
            
            state.effects.reverbDry.gain.value = 0.7;
            state.effects.reverbWet.gain.value = 0.3;
            
            // Podczamy
            state.effects.reverbDry.connect(state.masterGain);
            state.effects.reverb.connect(state.effects.reverbWet);
            state.effects.reverbWet.connect(state.masterGain);
        }

        // Inicjalizacja fortepianu
        function initPiano() {
            state.instruments.piano = {
                output: state.audioContext.createGain(),
                
                play: function(frequency, time, duration, velocity = 0.7) {
                    try {
                        // Oscylator (g贸wny d藕wik)
                        const osc = state.audioContext.createOscillator();
                        osc.type = 'triangle';
                        osc.frequency.value = frequency;
                        
                        // Obwiednia amplitudy (ADSR)
                        const gainNode = state.audioContext.createGain();
                        
                        // Parametry obwiedni
                        const now = state.audioContext.currentTime;
                        const startTime = time || now;
                        const attack = 0.02;
                        const decay = 0.2;
                        const sustain = 0.6;
                        const release = 0.8;
                        
                        // Ustaw obwiedni
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(velocity, startTime + attack);
                        gainNode.gain.linearRampToValueAtTime(velocity * sustain, startTime + attack + decay);
                        gainNode.gain.setValueAtTime(velocity * sustain, startTime + duration - release);
                        gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                        
                        // Filtry dla bogatszego brzmienia
                        const filter = state.audioContext.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.value = 2000 + (velocity * 2000);
                        
                        // Dodatkowy oscylator dla harmonicznych
                        const osc2 = state.audioContext.createOscillator();
                        osc2.type = 'sine';
                        osc2.frequency.value = frequency * 2; // Oktawa wy偶ej
                        
                        const gainNode2 = state.audioContext.createGain();
                        gainNode2.gain.value = velocity * 0.2; // Cichszy
                        
                        // Poczenia
                        osc.connect(filter);
                        filter.connect(gainNode);
                        gainNode.connect(this.output);
                        
                        osc2.connect(gainNode2);
                        gainNode2.connect(this.output);
                        
                        // Start i stop
                        osc.start(startTime);
                        osc2.start(startTime);
                        
                        osc.stop(startTime + duration);
                        osc2.stop(startTime + duration);
                        
                        // Wizualizacja
                        const xPos = Math.random() * visualizer.element.clientWidth;
                        const color = `hsl(${(frequency % 200) + 30}, 80%, 60%)`;
                        const noteVisual = visualizer.createNote(xPos, color);
                        
                        // Dodanie animacji dla zagranych nut
                        if (noteVisual) {
                            noteVisual.classList.add('active');
                            setTimeout(() => {
                                noteVisual.classList.remove('active');
                            }, duration * 1000);
                        }
                        
                        return { osc, gainNode, filter };
                        
                    } catch (error) {
                        console.error("Bd fortepianu:", error);
                    }
                },
                
                playChord: function(frequencies, time, duration, velocity = 0.7) {
                    frequencies.forEach((freq, index) => {
                        // Lekkie przesunicia czasowe dla naturalnoci
                        const offset = index * 0.02;
                        this.play(freq, time + offset, duration, velocity - (index * 0.1));
                    });
                }
            };
            
            // Podcz do efekt贸w
            state.instruments.piano.output.connect(state.effects.reverbDry);
            state.instruments.piano.output.connect(state.effects.reverb);
            
            // Ustaw gono
            state.instruments.piano.output.gain.value = 0.7;
        }

        // Inicjalizacja basu
        function initBass() {
            state.instruments.bass = {
                output: state.audioContext.createGain(),
                
                play: function(frequency, time, duration, velocity = 0.8) {
                    try {
                        // Oscylator basu (podstawowy d藕wik)
                        const osc = state.audioContext.createOscillator();
                        osc.type = 'sawtooth';
                        osc.frequency.value = frequency;
                        
                        // Obwiednia amplitudy
                        const gainNode = state.audioContext.createGain();
                        
                        // Parametry obwiedni
                        const now = state.audioContext.currentTime;
                        const startTime = time || now;
                        const attack = 0.05;
                        const decay = 0.1;
                        const sustain = 0.8;
                        const release = 0.5;
                        
                        // Ustaw obwiedni
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(velocity, startTime + attack);
                        gainNode.gain.linearRampToValueAtTime(velocity * sustain, startTime + attack + decay);
                        gainNode.gain.setValueAtTime(velocity * sustain, startTime + duration - release);
                        gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                        
                        // Filtr dolnoprzepustowy
                        const filter = state.audioContext.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.value = 500;
                        filter.Q.value = 1;
                        
                        // Compressor dla kontroli dynamiki
                        const compressor = state.audioContext.createDynamicsCompressor();
                        compressor.threshold.value = -24;
                        compressor.knee.value = 30;
                        compressor.ratio.value = 12;
                        compressor.attack.value = 0.003;
                        compressor.release.value = 0.25;
                        
                        // Poczenia
                        osc.connect(filter);
                        filter.connect(gainNode);
                        gainNode.connect(compressor);
                        compressor.connect(this.output);
                        
                        // Start i stop
                        osc.start(startTime);
                        osc.stop(startTime + duration);
                        
                        // Wizualizacja
                        const color = 'hsl(240, 70%, 50%)'; // Niebieski
                        visualizer.createNote(Math.random() * 100, color, duration * 1000);
                        
                        return { osc, gainNode, filter };
                        
                    } catch (error) {
                        console.error("Bd basu:", error);
                    }
                }
            };
            
            // Podcz do wyjcia
            state.instruments.bass.output.connect(state.effects.reverbDry);
            
            // Ustaw gono
            state.instruments.bass.output.gain.value = 0.5;
        }

        // Inicjalizacja perkusji
        function initDrums() {
            state.instruments.drums = {
                output: state.audioContext.createGain(),
                
                playKick: function(time, velocity = 0.8) {
                    try {
                        const now = state.audioContext.currentTime;
                        const startTime = time || now;
                        
                        // Oscylator dla stopy
                        const osc = state.audioContext.createOscillator();
                        const gainNode = state.audioContext.createGain();
                        
                        // Obwiednia czstotliwoci (opadajca)
                        osc.frequency.setValueAtTime(150, startTime);
                        osc.frequency.exponentialRampToValueAtTime(50, startTime + 0.3);
                        
                        // Obwiednia gonoci
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(velocity, startTime + 0.005);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 0.3);
                        
                        // Poczenia
                        osc.connect(gainNode);
                        gainNode.connect(this.output);
                        
                        // Start i stop
                        osc.start(startTime);
                        osc.stop(startTime + 0.3);
                        
                        // Wizualizacja
                        const color = 'hsl(0, 70%, 50%)'; // Czerwony
                        visualizer.createNote(Math.random() * 60, color, 300);
                        
                    } catch (error) {
                        console.error("Bd stopy perkusyjnej:", error);
                    }
                },
                
                playSnare: function(time, velocity = 0.7) {
                    try {
                        const now = state.audioContext.currentTime;
                        const startTime = time || now;
                        
                        // Szum dla werbla
                        const noise = state.audioContext.createBufferSource();
                        const noiseFilter = state.audioContext.createBiquadFilter();
                        const noiseGain = state.audioContext.createGain();
                        
                        // Tworzenie bufora szumu
                        const bufferSize = state.audioContext.sampleRate * 0.5;
                        const buffer = state.audioContext.createBuffer(1, bufferSize, state.audioContext.sampleRate);
                        const data = buffer.getChannelData(0);
                        
                        for (let i = 0; i < bufferSize; i++) {
                            data[i] = Math.random() * 2 - 1;
                        }
                        
                        // Ustawienia filtra
                        noiseFilter.type = 'bandpass';
                        noiseFilter.frequency.value = 3000;
                        noiseFilter.Q.value = 0.9;
                        
                        // Obwiednia gonoci
                        noiseGain.gain.setValueAtTime(0, startTime);
                        noiseGain.gain.linearRampToValueAtTime(velocity * 0.6, startTime + 0.005);
                        noiseGain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.2);
                        
                        // Dodanie oscylatora dla "bodu" werbla
                        const osc = state.audioContext.createOscillator();
                        const oscGain = state.audioContext.createGain();
                        
                        osc.type = 'triangle';
                        osc.frequency.value = 180;
                        
                        oscGain.gain.setValueAtTime(0, startTime);
                        oscGain.gain.linearRampToValueAtTime(velocity * 0.5, startTime + 0.005);
                        oscGain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
                        
                        // Poczenia
                        noise.buffer = buffer;
                        noise.connect(noiseFilter);
                        noiseFilter.connect(noiseGain);
                        noiseGain.connect(this.output);
                        
                        osc.connect(oscGain);
                        oscGain.connect(this.output);
                        
                        // Start i stop
                        noise.start(startTime);
                        osc.start(startTime);
                        
                        noise.stop(startTime + 0.2);
                        osc.stop(startTime + 0.1);
                        
                        // Wizualizacja
                        const color = 'hsl(30, 70%, 50%)'; // Pomaraczowy
                        visualizer.createNote(60 + Math.random() * 60, color, 200);
                        
                    } catch (error) {
                        console.error("Bd werbla:", error);
                    }
                },
                
                playHiHat: function(time, velocity = 0.6, open = false) {
                    try {
                        const now = state.audioContext.currentTime;
                        const startTime = time || now;
                        
                        // Czas trwania d藕wiku
                        const duration = open ? 0.2 : 0.05;
                        
                        // Szum dla hi-hatu
                        const noise = state.audioContext.createBufferSource();
                        const noiseFilter = state.audioContext.createBiquadFilter();
                        const noiseGain = state.audioContext.createGain();
                        
                        // Tworzenie bufora szumu
                        const bufferSize = state.audioContext.sampleRate * 0.5;
                        const buffer = state.audioContext.createBuffer(1, bufferSize, state.audioContext.sampleRate);
                        const data = buffer.getChannelData(0);
                        
                        for (let i = 0; i < bufferSize; i++) {
                            data[i] = Math.random() * 2 - 1;
                        }
                        
                        // Ustawienia filtra
                        noiseFilter.type = 'highpass';
                        noiseFilter.frequency.value = 8000;
                        
                        // Obwiednia gonoci
                        noiseGain.gain.setValueAtTime(0, startTime);
                        noiseGain.gain.linearRampToValueAtTime(velocity * 0.3, startTime + 0.001);
                        noiseGain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                        
                        // Poczenia
                        noise.buffer = buffer;
                        noise.connect(noiseFilter);
                        noiseFilter.connect(noiseGain);
                        noiseGain.connect(this.output);
                        
                        // Start i stop
                        noise.start(startTime);
                        noise.stop(startTime + duration);
                        
                        // Wizualizacja
                        const color = 'hsl(60, 70%, 50%)'; // 呕贸ty
                        visualizer.createNote(120 + Math.random() * 60, color, duration * 1000);
                        
                    } catch (error) {
                        console.error("Bd hi-hatu:", error);
                    }
                }
            };
            
            // Podcz do wyjcia
            state.instruments.drums.output.connect(state.masterGain);
            
            // Ustaw gono
            state.instruments.drums.output.gain.value = 0.6;
        }

        // Inicjalizacja trbki
        function initTrumpet() {
            state.instruments.trumpet = {
                output: state.audioContext.createGain(),
                
                play: function(frequency, time, duration, velocity = 0.6) {
                    try {
                        const now = state.audioContext.currentTime;
                        const startTime = time || now;
                        
                        // Oscylator dla trbki
                        const osc = state.audioContext.createOscillator();
                        osc.type = 'square';
                        osc.frequency.value = frequency;
                        
                        // Filtr dla charakterystycznego brzmienia
                        const filter = state.audioContext.createBiquadFilter();
                        filter.type = 'bandpass';
                        filter.frequency.value = frequency * 1.5;
                        filter.Q.value = 2;
                        
                        // Obwiednia gonoci
                        const gainNode = state.audioContext.createGain();
                        
                        // Parametry
                        const attack = 0.05;
                        const decay = 0.1;
                        const sustain = 0.7;
                        const release = 0.2;
                        
                        // Ustaw obwiedni gonoci
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(velocity, startTime + attack);
                        gainNode.gain.linearRampToValueAtTime(velocity * sustain, startTime + attack + decay);
                        gainNode.gain.setValueAtTime(velocity * sustain, startTime + duration - release);
                        gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
                        
                        // Dodatkowy oscylator dla wzbogacenia brzmienia
                        const osc2 = state.audioContext.createOscillator();
                        osc2.type = 'sawtooth';
                        osc2.frequency.value = frequency * 0.999; // Nieznaczne rozstrojenie
                        
                        const gain2 = state.audioContext.createGain();
                        gain2.gain.value = velocity * 0.3;
                        
                        // Poczenia
                        osc.connect(filter);
                        filter.connect(gainNode);
                        gainNode.connect(this.output);
                        
                        osc2.connect(gain2);
                        gain2.connect(filter);
                        
                        // Start i stop
                        osc.start(startTime);
                        osc2.start(startTime);
                        
                        osc.stop(startTime + duration);
                        osc2.stop(startTime + duration);
                        
                        // Wizualizacja
                        const color = 'hsl(0, 80%, 60%)'; // Czerwony
                        visualizer.createNote(180 + Math.random() * 60, color, duration * 1000);
                        
                    } catch (error) {
                        console.error("Bd trbki:", error);
                    }
                }
            };
            
            // Podcz do efekt贸w
            state.instruments.trumpet.output.connect(state.effects.reverbDry);
            state.instruments.trumpet.output.connect(state.effects.reverb);
            
            // Ustaw gono
            state.instruments.trumpet.output.gain.value = 0.5;
        }

        // Odtwarzanie kr贸tkiego d藕wiku testowego
        function playTestSound() {
            if (!state.audioContext) return;
            
            // Odtw贸rz kr贸tki akord testowy
            const time = state.audioContext.currentTime;
            
            // Prosta sekwencja C Major
            if (state.instruments.piano) {
                state.instruments.piano.playChord([
                    NOTE_FREQUENCIES.C * 2, 
                    NOTE_FREQUENCIES.E * 2,
                    NOTE_FREQUENCIES.G * 2
                ], time, 0.5, 0.5);
            }
            
            // Efekt wizualny
            createJazzEffect();
        }

        // CZ 5: FUNKCJE STERUJCE ODTWARZANIEM

        // Przeczanie odtwarzania
        function togglePlayJazz() {
            if (state.isPlaying) {
                stopJazz();
            } else {
                startJazz();
            }
        }

        // Rozpoczcie odtwarzania
        function startJazz() {
            if (!state.audioInitialized) {
                updateStatus("Najpierw zainicjalizuj audio!");
                return;
            }
            
            // Aktualizacja UI
            document.getElementById('startButton').textContent = "STOP JAZZU";
            document.getElementById('startButton').classList.add('active');
            
            // Generuj now progresj akord贸w
            generateNewProgression();
            
            // Ustaw stan odtwarzania
            state.isPlaying = true;
            state.progressionIndex = 0;
            
            // Uruchom sekwencj akord贸w
            playChordSequence();
            
            // Aktualizuj status
            updateStatus(`Gra: ${state.currentChord || 'adowanie...'}; Nastr贸j: ${state.currentMood}`);
            
            // Efekt wizualny
            createJazzEffect();
        }

        // Zatrzymanie odtwarzania
        function stopJazz() {
            // Aktualizacja UI
            document.getElementById('startButton').textContent = "START JAZZU";
            document.getElementById('startButton').classList.remove('active');
            
            // Zatrzymaj timery
            if (state.chordTimer) {
                clearTimeout(state.chordTimer);
                state.chordTimer = null;
            }
            
            // Ustaw stan
            state.isPlaying = false;
            
            // Wyczy wizualizacj
            visualizer.clearNotes();
            
            // Aktualizuj status
            updateStatus("Zatrzymano. Kliknij START, aby kontynuowa...");
        }

        // Generowanie nowej progresji akord贸w
        function generateNewProgression() {
            // Wybierz progresj odpowiedni dla stylu
            const progressions = JAZZ_PROGRESSIONS[state.style] || JAZZ_PROGRESSIONS.swing;
            
            // Wybierz losow progresj z listy
            const randomIndex = Math.floor(Math.random() * progressions.length);
            state.currentProgression = [...progressions[randomIndex]];
            
            console.log(`Nowa progresja (${state.style}):`, state.currentProgression);
            
            // Resetuj indeks
            state.progressionIndex = 0;
        }

        // Zmiana losowego nastroju
        function changeRandomMood() {
            const newMood = MOODS[Math.floor(Math.random() * MOODS.length)];
            state.currentMood = newMood;
            visualizer.updateMoodDisplay(newMood);
        }

        // Zmiana losowego stylu
        function changeRandomStyle() {
            const styles = ['swing', 'bebop', 'fusion', 'modal'];
            const randomStyle = styles[Math.floor(Math.random() * styles.length)];
            setStyle(randomStyle);
        }

        // Zmiana losowego tempa
        function changeRandomTempo() {
            // Losowa zmiana tempa +/- 20 BPM
            const tempoChange = Math.floor(Math.random() * 40) - 20;
            const newTempo = Math.max(60, Math.min(240, state.tempo + tempoChange));
            
            // Aktualizuj suwak
            document.getElementById('tempo').value = newTempo;
            updateTempo();
        }

        // Odtwarzanie sekwencji akord贸w
        function playChordSequence() {
            if (!state.isPlaying) return;
            
            // Oblicz czas midzy akordami
            const beatDuration = 60 / state.tempo; // czas jednego uderzenia w sekundach
            const chordDuration = beatDuration * 4; // zakadamy 4/4
            
            // Pobierz aktualny akord
            const chord = state.currentProgression[state.progressionIndex];
            
            // Odtw贸rz akord
            playJazzChord(chord, chordDuration);
            
            // Przygotuj nastpny akord
            state.progressionIndex = (state.progressionIndex + 1) % state.currentProgression.length;
            
            // Ustaw timer dla nastpnego akordu
            state.chordTimer = setTimeout(() => {
                playChordSequence();
            }, chordDuration * 1000);
        }

        // Odtwarzanie pojedynczego akordu jazzowego
        function playJazzChord(chordName, duration) {
            if (!state.audioContext || !chordName) return;
            
            // Aktualizuj bie偶cy akord
            state.currentChord = chordName;
            visualizer.updateChordDisplay(chordName);
            
            // Dekodowanie nazwy akordu
            const rootNote = chordName.slice(0, chordName.search(/maj|m|dim|sus|aug|[0-9]/));
            
            // Pobierz czstotliwo podstawow
            let baseFreq = NOTE_FREQUENCIES[rootNote] || 261.63; // C4 jako domylna
            
            // Ustal, czy mamy akord durowy czy molowy
            const isMinor = chordName.includes('m') && !chordName.includes('maj');
            
            // Ustal interway w zale偶noci od typu akordu
            let intervals = [];
            
            if (chordName.includes('maj7')) {
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.major7th];
            } else if (chordName.includes('maj9')) {
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.major7th, INTERVALS.major9th];
            } else if (chordName.includes('m7b5')) {
                intervals = [1, INTERVALS.minor3rd, INTERVALS.tritone, INTERVALS.minor7th];
            } else if (chordName.includes('m7')) {
                intervals = [1, INTERVALS.minor3rd, INTERVALS.perfect5th, INTERVALS.minor7th];
            } else if (chordName.includes('m9')) {
                intervals = [1, INTERVALS.minor3rd, INTERVALS.perfect5th, INTERVALS.minor7th, INTERVALS.major9th];
            } else if (chordName.includes('7b9')) {
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.minor7th, INTERVALS.minor9th];
            } else if (chordName.includes('9')) {
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.minor7th, INTERVALS.major9th];
            } else if (chordName.includes('13')) {
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.minor7th, INTERVALS.major9th, INTERVALS.major13th];
            } else if (chordName.includes('7')) {
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.minor7th];
            } else if (chordName.includes('dim')) {
                intervals = [1, INTERVALS.minor3rd, INTERVALS.tritone, INTERVALS.major6th];
            } else if (chordName.includes('sus4')) {
                intervals = [1, INTERVALS.perfect4th, INTERVALS.perfect5th];
            } else if (chordName.includes('6')) {
                if (isMinor) {
                    intervals = [1, INTERVALS.minor3rd, INTERVALS.perfect5th, INTERVALS.major6th];
                } else {
                    intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th, INTERVALS.major6th];
                }
            } else if (isMinor) {
                intervals = [1, INTERVALS.minor3rd, INTERVALS.perfect5th];
            } else {
                // Domylnie major
                intervals = [1, INTERVALS.major3rd, INTERVALS.perfect5th];
            }
            
            // Oblicz czstotliwoci dla akordu
            const frequencies = intervals.map(interval => baseFreq * interval);
            
            // Czas aktualny
            const now = state.audioContext.currentTime;
            
            // Odtw贸rz wszystkie instrumenty
            if (state.piano) {
                state.instruments.piano.playChord(frequencies, now, duration);
            }
            
            if (state.bass) {
                playBassLine(chordName, now, duration);
            }
            
            if (state.drums) {
                playDrumPattern(now, duration);
            }
            
            if (state.trumpet && Math.random() < 0.3) {
                // Trbka gra rzadziej - tylko z 30% prawdopodobiestwem
                playTrumpetLine(chordName, now, duration);
            }
        }

        // Odtwarzanie linii basowej
        function playBassLine(chordName, time, duration) {
            if (!state.instruments.bass) return;
            
            // Dekodowanie nazwy akordu
            const rootNote = chordName.slice(0, chordName.search(/maj|m|dim|sus|aug|[0-9]/));
            
            // Pobierz czstotliwo podstawow
            let baseFreq = NOTE_FREQUENCIES[rootNote] || 261.63; // C4 jako domylna
            baseFreq = baseFreq / 2; // Oktawa ni偶ej dla basu
            
            // Czas aktualny
            const now = time || state.audioContext.currentTime;
            
            // Wybierz wzorzec basowy zale偶nie od stylu
            let pattern;
            
            switch(state.style) {
                case 'swing':
                    // Walking bass - 4 nuty na akord
                    pattern = [
                        { time: 0, note: baseFreq },
                        { time: duration / 4, note: baseFreq * INTERVALS.perfect5th },
                        { time: duration / 2, note: baseFreq * INTERVALS.major3rd },
                        { time: duration * 0.75, note: baseFreq * INTERVALS.perfect5th * 0.75 }
                    ];
                    break;
                    
                case 'bebop':
                    // Szybszy walking bass z przejciami chromatycznymi
                    pattern = [
                        { time: 0, note: baseFreq },
                        { time: duration / 4, note: baseFreq * INTERVALS.major2nd },
                        { time: duration / 2, note: baseFreq * INTERVALS.major3rd },
                        { time: duration * 0.75, note: baseFreq * INTERVALS.perfect4th }
                    ];
                    break;
                    
                case 'fusion':
                    // Bardziej synkopowany groove
                    pattern = [
                        { time: 0, note: baseFreq },
                        { time: duration * 0.375, note: baseFreq },
                        { time: duration / 2, note: baseFreq * INTERVALS.perfect5th },
                        { time: duration * 0.875, note: baseFreq * INTERVALS.perfect4th }
                    ];
                    break;
                    
                case 'modal':
                    // Minimalistyczny, dugo trzymane nuty
                    pattern = [
                        { time: 0, note: baseFreq },
                        { time: duration / 2, note: baseFreq * INTERVALS.perfect5th }
                    ];
                    break;
                    
                default:
                    // Standardowy walking bass
                    pattern = [
                        { time: 0, note: baseFreq },
                        { time: duration / 4, note: baseFreq * INTERVALS.perfect5th },
                        { time: duration / 2, note: baseFreq * INTERVALS.major3rd },
                        { time: duration * 0.75, note: baseFreq * INTERVALS.perfect5th * 0.75 }
                    ];
            }
            
            // Zagraj wzorzec
            pattern.forEach(note => {
                state.instruments.bass.play(note.note, now + note.time, duration / 4);
            });
        }

        // Odtwarzanie wzorca perkusyjnego
        function playDrumPattern(time, duration) {
            if (!state.instruments.drums) return;
            
            // Czas aktualny
            const now = time || state.audioContext.currentTime;
            
            // Wybierz wzorzec perkusyjny zale偶nie od stylu
            let kickPattern, snarePattern, hihatPattern;
            
            switch(state.style) {
                case 'swing':
                    // Klasyczny swing
                    kickPattern = [0, duration / 2];
                    snarePattern = [duration / 4, duration * 0.75];
                    hihatPattern = [0, duration / 4, duration / 2, duration * 0.75];
                    break;
                    
                case 'bebop':
                    // Szybszy, bardziej zo偶ony rytm
                    kickPattern = [0, duration * 0.6];
                    snarePattern = [duration / 4, duration * 0.75];
                    hihatPattern = [0, duration / 8, duration / 4, duration * 3/8, duration / 2, duration * 5/8, duration * 0.75, duration * 7/8];
                    break;
                    
                case 'fusion':
                    // Synkopowany, funkowy rytm
                    kickPattern = [0, duration * 0.375, duration * 0.75];
                    snarePattern = [duration / 4, duration * 0.75];
                    hihatPattern = [0, duration / 8, duration / 4, duration * 3/8, duration / 2, duration * 5/8, duration * 0.75, duration * 7/8];
                    break;
                    
                case 'modal':
                    // Minimalistyczny, przestrzenny
                    kickPattern = [0];
                    snarePattern = [duration / 2];
                    hihatPattern = [duration / 4, duration * 0.75];
                    break;
                    
                default:
                    // Standardowy jazz
                    kickPattern = [0, duration / 2];
                    snarePattern = [duration / 4, duration * 0.75];
                    hihatPattern = [0, duration / 4, duration / 2, duration * 0.75];
            }
            
            // Zagraj wzorce
            kickPattern.forEach(time => {
                state.instruments.drums.playKick(now + time);
            });
            
            snarePattern.forEach(time => {
                state.instruments.drums.playSnare(now + time);
            });
            
            hihatPattern.forEach(time => {
                // Sprawd藕 czy ma by otwarty hi-hat
                const isOpen = time === duration / 2; // Otwarty na "3"
                state.instruments.drums.playHiHat(now + time, 0.6, isOpen);
            });
        }

        // Odtwarzanie linii trbki
        function playTrumpetLine(chordName, time, duration) {
            if (!state.instruments.trumpet) return;
            
            // Dekodowanie nazwy akordu
            const rootNote = chordName.slice(0, chordName.search(/maj|m|dim|sus|aug|[0-9]/));
            
            // Pobierz czstotliwo podstawow
            let baseFreq = NOTE_FREQUENCIES[rootNote] || 261.63; // C4 jako domylna
            baseFreq = baseFreq * 2; // Oktawa wy偶ej dla trbki
            
            // Czas aktualny
            const now = time || state.audioContext.currentTime;
            
            // Wybierz losow fraz trbki
            const patternType = Math.floor(Math.random() * 4);
            
            switch(patternType) {
                case 0:
                    // Pojedyncza duga nuta
                    state.instruments.trumpet.play(baseFreq, now + duration * 0.25, duration * 0.5);
                    break;
                    
                case 1:
                    // Dwie nuty
                    state.instruments.trumpet.play(baseFreq, now + duration * 0.25, duration * 0.25);
                    state.instruments.trumpet.play(baseFreq * INTERVALS.perfect5th, now + duration * 0.6, duration * 0.3);
                    break;
                    
                case 2:
                    // Triola
                    state.instruments.trumpet.play(baseFreq, now + duration * 0.25, duration * 0.15);
                    state.instruments.trumpet.play(baseFreq * INTERVALS.major3rd, now + duration * 0.45, duration * 0.15);
                    state.instruments.trumpet.play(baseFreq * INTERVALS.perfect5th, now + duration * 0.65, duration * 0.25);
                    break;
                    
                case 3:
                    // Fraza kadencyjna
                    state.instruments.trumpet.play(baseFreq * INTERVALS.major7th, now + duration * 0.1, duration * 0.2);
                    state.instruments.trumpet.play(baseFreq * INTERVALS.perfect5th, now + duration * 0.4, duration * 0.2);
                    state.instruments.trumpet.play(baseFreq, now + duration * 0.7, duration * 0.3);
                    break;
            }
        }

        // CZ 6: FUNKCJE UI I STEROWANIA

        // Przeczanie trybu Auto-Jazz
        function toggleAutoJazz() {
            state.autoJazz = !state.autoJazz;
            
            if (state.autoJazz) {
                autoJazz.start();
                
                // Jeli nie odtwarzamy, uruchom odtwarzanie
                if (!state.isPlaying && state.audioInitialized) {
                    startJazz();
                }
                
                updateStatus(`Auto-Jazz WCZONY! Nastr贸j: ${state.currentMood}`);
            } else {
                autoJazz.stop();
                updateStatus(`Auto-Jazz wyczony. Nastr贸j: ${state.currentMood}`);
            }
        }

        // Aktualizacja tempa
        function updateTempo() {
            state.tempo = parseInt(document.getElementById('tempo').value);
            document.getElementById('tempoValue').textContent = `${state.tempo} BPM`;
            
            // Jeli odtwarzamy, zatrzymaj i uruchom ponownie sekwencj
            if (state.isPlaying) {
                // Zatrzymaj bie偶c sekwencj
                if (state.chordTimer) {
                    clearTimeout(state.chordTimer);
                }
                
                // Uruchom ponownie
                playChordSequence();
            }
        }

        // Ustawienie stylu muzycznego
        function setStyle(style) {
            // Aktualizuj stan
            state.style = style;
            
            // Aktualizuj przyciski
            document.getElementById('styleSwing').classList.toggle('active', style === 'swing');
            document.getElementById('styleBebop').classList.toggle('active', style === 'bebop');
            document.getElementById('styleFusion').classList.toggle('active', style === 'fusion');
            document.getElementById('styleModal').classList.toggle('active', style === 'modal');
            
            // Dostosuj tempo do stylu
            let newTempo;
            switch (style) {
                case 'swing':
                    newTempo = 120 + Math.floor(Math.random() * 20);
                    break;
                case 'bebop':
                    newTempo = 160 + Math.floor(Math.random() * 40);
                    break;
                case 'fusion':
                    newTempo = 95 + Math.floor(Math.random() * 25);
                    break;
                case 'modal':
                    newTempo = 80 + Math.floor(Math.random() * 40);
                    break;
                default:
                    newTempo = 120;
            }
            
            // Aktualizuj tempo
            document.getElementById('tempo').value = newTempo;
            updateTempo();
            
            // Generuj now progresj akord贸w dopasowan do stylu
            generateNewProgression();
            
            // Jeli odtwarzamy, zaktualizuj sekwencj
            if (state.isPlaying) {
                // Zatrzymaj bie偶c sekwencj
                if (state.chordTimer) {
                    clearTimeout(state.chordTimer);
                }
                
                // Uruchom ponownie
                playChordSequence();
            }
        }

        // Przeczanie instrumentu
        function toggleInstrument(instrument) {
            // Aktualizuj stan
            state[instrument] = !state[instrument];
            
            // Aktualizuj przycisk
            const button = document.getElementById(`${instrument}Toggle`);
            button.classList.toggle('active', state[instrument]);
            
            const label = instrument.charAt(0).toUpperCase() + instrument.slice(1);
            button.textContent = `${label}: ${state[instrument] ? 'ON' : 'OFF'}`;
            
            // Efekt wizualny
            createJazzEffect();
        }

        // Efekt wizualny dla akcji jazzowych
        function createJazzEffect() {
            const container = document.getElementById('notesAnimation');
            const symbols = ['', '', '', '', '', '', '', '', ''];
            const count = 10;
            
            for (let i = 0; i < count; i++) {
                // Stw贸rz element nuty
                const note = document.createElement('div');
                note.className = 'note';
                note.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                
                // Losowa pozycja i styl
                note.style.left = `${Math.random() * 100}%`;
                note.style.top = `${Math.random() * 100}%`;
                
                // Losowy kolor
                const hue = Math.random() * 360;
                note.style.color = `hsl(${hue}, 80%, 60%)`;
                
                // Losowe op贸藕nienie i czas animacji
                note.style.animationDuration = `${2 + Math.random() * 3}s`;
                note.style.animationDelay = `${Math.random() * 0.5}s`;
                
                // Dodaj do kontenera
                container.appendChild(note);
                
                // Usu po zakoczeniu animacji
                setTimeout(() => {
                    if (container.contains(note)) {
                        container.removeChild(note);
                    }
                }, 5000);
            }
        }

        // Aktualizacja statusu
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Wywietlanie komunikatu o bdzie
        function displayError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Ukryj po 5 sekundach
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Inicjalizacja aplikacji po zaadowaniu strony
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>